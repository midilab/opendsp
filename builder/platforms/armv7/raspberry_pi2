#!/bin/bash

# the filesystem image to use
filesystem_image="ArchLinuxARM-rpi-armv7-latest.tar.gz"

# sdcard layout
partition_type=( "fat" "ext4" "ext4" )
partition_size=( 200 6000 256 )
partition_label=( "BOOT" "ROOT" "OPENDSP" )
partition_mnt=( "/boot" "/" "/home/opendsp/data" )

post_filesystem_install() {

}

tunning_img() {

	# resize sd user data script
	echo '#!/bin/bash' > opendsp/usr/bin/resizesd
	echo 'set -e' >> opendsp/usr/bin/resizesd
	echo 'read -p "Do you want to resize your data partition? Press enter to continue"' >> opendsp/usr/bin/resizesd
	echo 'echo "Stoping OpenDSP and services..."' >> opendsp/usr/bin/resizesd
	echo 'systemctl stop opendsp || true' >> opendsp/usr/bin/resizesd
	echo 'systemctl stop smb || true' >> opendsp/usr/bin/resizesd
	echo 'systemctl stop nmb || true' >> opendsp/usr/bin/resizesd
	echo 'sleep 5' >> opendsp/usr/bin/resizesd
	echo 'umount -v /home/opendsp/data || true' >> opendsp/usr/bin/resizesd
	echo 'echo "Resizing..."' >> opendsp/usr/bin/resizesd
	echo 'parted /dev/mmcblk0 <<EOF' >> opendsp/usr/bin/resizesd
	echo 'resizepart' >> opendsp/usr/bin/resizesd
	echo '3' >> opendsp/usr/bin/resizesd
	echo '-16M' >> opendsp/usr/bin/resizesd
	echo 'q' >> opendsp/usr/bin/resizesd
	echo 'EOF' >> opendsp/usr/bin/resizesd
	echo 'e2fsck -p -f /dev/mmcblk0p3' >> opendsp/usr/bin/resizesd
	echo 'resize2fs /dev/mmcblk0p3' >> opendsp/usr/bin/resizesd
	echo 'read -p "Done! Press enter to reboot your machine..."' >> opendsp/usr/bin/resizesd
	echo 'mount -o remount,rw /' >> opendsp/usr/bin/resizesd
	echo 'rm /usr/bin/resizesd' >> opendsp/usr/bin/resizesd
	echo 'rm -r /home/opendsp/data/lost+found || true' >> opendsp/usr/bin/resizesd
	echo 'shutdown -r now' >> opendsp/usr/bin/resizesd

	sudo chmod 755 opendsp/usr/bin/resizesd

	# setup boot/config.txt
	#sed -i '/gpu_mem/d' opendsp/boot/config.txt		
	#echo "gpu_mem=64" >> opendsp/boot/config.txt
	echo "# video accell drivers" >> opendsp/boot/config.txt
	echo "#dtoverlay=vc4-fkms-v3d" >> opendsp/boot/config.txt
	echo "#dtoverlay=vc4-kms-v3d" >> opendsp/boot/config.txt

	echo "# on-board audio" >> opendsp/boot/config.txt
	echo "dtparam=audio=on" >> opendsp/boot/config.txt
	echo "disable_audio_dither=1" >> opendsp/boot/config.txt
	echo "audio_pwm_mode=2" >> opendsp/boot/config.txt

	echo "# most common sound cards overlay drivers" >> opendsp/boot/config.txt
	echo "#dtoverlay=hifiberry-dacplus" >> opendsp/boot/config.txt
	echo "#dtoverlay=hifiberry-dac" >> opendsp/boot/config.txt
	echo "#dtoverlay=hifiberry-digi" >> opendsp/boot/config.txt
	echo "#dtoverlay=hifiberry-amp" >> opendsp/boot/config.txt
	echo "#dtoverlay=audioinjector-wm8731-audio" >> opendsp/boot/config.txt
	echo "#dtoverlay=iqaudio-dac" >> opendsp/boot/config.txt
	echo "#dtoverlay=iqaudio-dacplus" >> opendsp/boot/config.txt
	echo "#dtoverlay=iqaudio-digi-wm8804-audio" >> opendsp/boot/config.txt
	echo "#dtoverlay=pisound" >> opendsp/boot/config.txt
	echo "#dtoverlay=justboom-dac" >> opendsp/boot/config.txt
	echo "#dtoverlay=justboom-digi" >> opendsp/boot/config.txt
	echo "#dtoverlay=iqaudio-dac" >> opendsp/boot/config.txt

	echo "# enable MMAP support for jack" >> opendsp/boot/config.txt
	echo "dtoverlay=i2s-mmap" >> opendsp/boot/config.txt

	echo "# periphericals" >> opendsp/boot/config.txt
	echo "#dtoverlay=pi3-disable-bt" >> opendsp/boot/config.txt
	echo "#dtoverlay=pi3-disable-wifi" >> opendsp/boot/config.txt
	echo "enable_uart=1" >> opendsp/boot/config.txt
	echo "dtoverlay=pi3-miniuart-bt" >> opendsp/boot/config.txt
	echo "dtoverlay=midi-uart0" >> opendsp/boot/config.txt

	echo "# hdmi" >> opendsp/boot/config.txt
	echo "#hdmi_safe=1" >> opendsp/boot/config.txt
	echo "disable_overscan=1" >> opendsp/boot/config.txt
	echo "hdmi_force_hotplug=1" >> opendsp/boot/config.txt
	echo "hdmi_drive=2" >> opendsp/boot/config.txt
	echo "hdmi_group=1" >> opendsp/boot/config.txt
	echo "hdmi_mode=4" >> opendsp/boot/config.txt

	echo "# general" >> opendsp/boot/config.txt
	echo "disable_splash=1" >> opendsp/boot/config.txt
	echo "avoid_warnings=1" >> opendsp/boot/config.txt
	echo "max_usb_current=1" >> opendsp/boot/config.txt

	echo "# gpu overclock" >> opendsp/boot/config.txt
	echo "#force_turbo=1" >> opendsp/boot/config.txt
	echo "#boot_delay=1" >> opendsp/boot/config.txt
	echo "#avoid_pwm_pll=1" >> opendsp/boot/config.txt
	echo "#v3d_freq=450" >> opendsp/boot/config.txt

	echo "# overclock pi2" >> opendsp/boot/config.txt
	echo "#arm_freq=1050" >> opendsp/boot/config.txt
	echo "#over_voltage=4" >> opendsp/boot/config.txt
	echo "#core_freq=525" >> opendsp/boot/config.txt
	echo "#gpu_freq=350" >> opendsp/boot/config.txt
	echo "#sdram_freq=480" >> opendsp/boot/config.txt
	echo "#over_voltage_sdram_p=2" >> opendsp/boot/config.txt
	echo "#over_voltage_sdram_i=2" >> opendsp/boot/config.txt
	echo "#over_voltage_sdram_c=2" >> opendsp/boot/config.txt

	echo "# overclock pi3" >> opendsp/boot/config.txt
	echo "#arm_freq=1350" >> opendsp/boot/config.txt
	echo "#over_voltage=4" >> opendsp/boot/config.txt
	echo "#core_freq=500" >> opendsp/boot/config.txt
	
	# take uart usage off for console, we need it for MIDI uart
	sed -i 's/ console=ttyAMA0,115200//' opendsp/boot/cmdline.txt
	sed -i 's/ kgdboc=ttyAMA0,115200//' opendsp/boot/cmdline.txt
	# take off all visual noise at boot stage, set boot process to output only a blank screen
	sed -i 's/ console=tty1/ console=null fsck.repair=yes dwc_otg.speed=1 quiet logo.nologo consoleblank=0/' opendsp/boot/cmdline.txt
	# boot read only file system
	sed -i 's/ rw/ ro/' opendsp/boot/cmdline.txt	
	
	# set read only file systems
	cat <<EOF > opendsp/etc/fstab
# Static information about the filesystems.
# See fstab(5) for details.

# readonly filesystems
/dev/mmcblk0p1  /boot                   vfat    ro,auto,exec            0       2
/dev/mmcblk0p2  /                       ext4    defaults,noatime,ro     0       1
/dev/mmcblk0p3  /home/opendsp/data      ext4    defaults,noatime,rw     0       1
# ram memory runtime filesystems
tmpfs           /var/tmp        tmpfs   defaults,noatime,mode=0755      0       0
tmpfs           /var/log        tmpfs   defaults,noatime,mode=0755      0       0
EOF

	# install xf86 drivers for vc4 broadcom GPU
	retVal=-1
	while [ $retVal -ne 0 ]; do
		chroot opendsp pacman -S xf86-video-fbdev || true
		retVal=$?
	done	
}	

